using System;
using System.Collections.Generic;
using System.Diagnostics;
using System.IO;
using System.Linq;
using System.ServiceProcess;
using RepairTool.Core;

namespace RepairTool.Repairs.Activities.Malware
{
    public class MalwareBytes
    {
        /// <summary>
        /// Installs Malwarebytes to the target system
        /// </summary>
        public static void Install()
        {
            var runFile = EnvironmentVars.WINMAL + "mbam\\mb3-setup-54035.54035-3.6.1.2711-1.0.482-1.0.7469.exe";
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("Installing MBAM...", w);
            }
            // Prepare the process to run
            ProcessStartInfo start = new ProcessStartInfo();
            start.UseShellExecute = false;
            start.RedirectStandardOutput = true;
            start.RedirectStandardError = true;
            
            // Enter in the command line arguments, everything you would enter after the executable name itself
            start.Arguments = "/SP- /VERYSILENT /NORESTART /SUPPRESSMSGBOXES /NOCANCEL";

            // Enter the executable to run, including the complete path
            start.FileName = runFile;
            // Do you want to show a console window?
            start.WindowStyle = EnvironmentVars.processWindowHide;
            start.CreateNoWindow = EnvironmentVars.noConsoleWindow;
            int exitCode;


            // Run the external process & wait for it to finish
            using (Process proc = Process.Start(start))
            {
                proc.WaitForExit();
                System.Threading.Thread.Sleep(30000);
                var output = proc.StandardOutput.ReadToEnd();
                using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
                {
                    Logger.LogInfo(output, w);
                }
                // Retrieve the app's exit code
                exitCode = proc.ExitCode;
            }
        }

        /// <summary>
        /// Stops the MBAMservice
        /// </summary>
        public static void Close() // Hanging on this task
        {
            var serviceName = "MBAMservice";
            ServiceController serviceController = new ServiceController(serviceName);
            TimeSpan timeout = TimeSpan.FromMilliseconds(1000);
            serviceController.Stop();
            serviceController.WaitForStatus(ServiceControllerStatus.Running, timeout);
        }
        /// <summary>
        /// Kills the mbamtray.exe process
        /// </summary>
        public static void KillTray()
        {
            foreach (var process in Process.GetProcessesByName("mbamtray"))
            {
                process.Kill();
            }
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("Malwarebytes successfully closed...", w); // We are stopping somewhere before this log post...
            }
        }

        public static void InstallConfig()
        {
            DirectoryInfo dirInfo = new DirectoryInfo(EnvironmentVars.WINMAL + "mbam\\");
            List<FileInfo> fileInfo = dirInfo.GetFiles("*.json").ToList();
            string destDir = Environment.GetFolderPath(Environment.SpecialFolder.CommonApplicationData) +
                             "\\Malwarebytes\\MBAMService\\config\\";

            foreach (FileInfo foundFile in fileInfo)
            {
                var path = foundFile.FullName;
                
                File.Copy(path, destDir);
            }
        }

        public static void RulesInstaller()
        {
            var runFile = EnvironmentVars.WINMAL + "mbam\\mbam2-rules.exe";
            ProcessStartInfo rules = new ProcessStartInfo();
            rules.UseShellExecute = false;
            rules.RedirectStandardOutput = true;
            rules.Arguments = "/sp- /verysilent /supressmsgboxes /log=" + EnvironmentVars.RAWLOGDIR +
                              "mbam_rules_install.log /norestart";
            rules.FileName = runFile;
            rules.WindowStyle = EnvironmentVars.processWindowHide;
            rules.CreateNoWindow = EnvironmentVars.noConsoleWindow;

            using (Process proc = Process.Start(rules))
            {
                proc.WaitForExit();
                System.Threading.Thread.Sleep(30000);
                var output = proc.StandardOutput.ReadToEnd();
                using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
                {
                    Logger.LogInfo(output, w);
                }
            }
        }

        public static void Scan()
        {
            var runFile = EnvironmentVars.SYSDRIVE + "Program Files\\Malwarebytes\\Anti-Malware\\mbam.exe";
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("Launching MBAM, click the scan button when it comes up.", w);
            }
            // Prepare the process to run
            ProcessStartInfo start = new ProcessStartInfo();
            start.UseShellExecute = false;
            start.RedirectStandardOutput = true;
            // Enter the executable to run, including the complete path
            start.FileName = runFile;


            // Run the external process & wait for it to finish
            using (Process proc = Process.Start(start))
            {
                proc.WaitForExit();
            }
            
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("Done.", w);
            }
        }

        public static void Cleanup()
        {
            var runFile = EnvironmentVars.SYSDRIVE + "Program Files\\Malwarebytes\\Anti-Malware\\unins000.exe";
            // Prepare the process to run
            ProcessStartInfo start = new ProcessStartInfo();
            start.UseShellExecute = false;
            start.RedirectStandardOutput = true;
            start.RedirectStandardError = true;
            
            // Enter in the command line arguments, everything you would enter after the executable name itself
            start.Arguments = "/verysilent /suppressmsgboxes /norestart";

            // Enter the executable to run, including the complete path
            start.FileName = runFile;
            // Do you want to show a console window?
            start.WindowStyle = EnvironmentVars.processWindowHide;
            start.CreateNoWindow = EnvironmentVars.noConsoleWindow;
            int exitCode;


            // Run the external process & wait for it to finish
            using (Process proc = Process.Start(start))
            {
                proc.WaitForExit();
                System.Threading.Thread.Sleep(30000);
                var output = proc.StandardOutput.ReadToEnd();
                using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
                {
                    Logger.LogInfo(output, w);
                }
                // Retrieve the app's exit code
                exitCode = proc.ExitCode;
            }
            
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("MBAM cleaned up...", w);
            }
            using (StreamWriter w = File.AppendText(EnvironmentVars.LOGFILE))
            {
                Logger.LogInfo("System will need a restart...", w);
            }
            EnvironmentVars.RebootRequired = true;
        }
    }
}